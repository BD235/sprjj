generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(uuid()) @map("id_user")
  username             String?               @unique @map("username")
  email                String                @unique @map("email")
  password             String?               @map("password")
  name                 String?               @map("name")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  notifications        Notification[]
  suppliers            Supplier[]
  products             Product[]
  stockInTransactions  StockInTransaction[]
  stockOutTransactions StockOutTransaction[]
  roles                UserRole[]
  @@map("users")
}

model Role {
  id            String         @id @default(uuid()) @map("id_role")
  name          String         @unique @map("nama_role")
  status        String         @default("active") @map("status")
  users         UserRole[]
  notifications Notification[]

  @@map("roles")
}

model UserRole {
  userId String @map("id_user")
  roleId String @map("id_role")
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model Product {
  id          String          @id @default(uuid()) @map("id_stok")
  userId      String          @map("id_user")
  stockName   String          @map("nama_stok")
  category    String?         @map("kategori")
  unit        MeasurementUnit @default(GRAM) @map("satuan")
  price       Decimal         @map("harga_beli")
  supplier    String?         @map("supplier")
  supplierId  String?         @map("id_pemasok")
  quantity    Int             @default(0) @map("jumlah")
  lowStock    Int?            @map("sisa_stok")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  supplierRef Supplier?       @relation(fields: [supplierId], references: [id])
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ðŸ”¹ hubungan ke resep (bahan ini dipakai di menu apa saja)
  recipes Recipe[]

  // ðŸ”¹ transaksi MASUK & KELUAR dipisah
  stockInTransactions  StockInTransaction[]
  stockOutTransactions StockOutTransaction[]

  notifications Notification[]
  deletedAt     DateTime?      @map("deleted_at")

  @@index([userId, stockName])
  @@index([userId, deletedAt])
  @@map("stok")
}

model Supplier {
  id             String               @id @default(uuid()) @map("id_pemasok")
  userId         String               @map("id_user")
  name           String               @map("nama_pemasok")
  category       String?              @map("kategori")
  whatsappNumber String?              @map("nomor_wa")
  address        String?              @map("alamat")
  status         SupplierStatus       @default(ACTIVE) @map("status")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  products       Product[]
  transactions   StockInTransaction[]

  deletedAt DateTime? @map("deleted_at")

  @@index([userId, name], map: "pemasok_id_user_nama_idx")
  @@index([userId, deletedAt])
  @@map("pemasok")
}

model StockInTransaction {
  id              String            @id @default(uuid()) @map("id_transaksi_masuk")
  userId          String            @map("id_user")
  productId       String            @map("id_stok")
  supplierId      String?           @map("id_pemasok")
  transactionName String            @map("nama_transaksi")
  totalAmount     Decimal           @map("total_harga")
  status          TransactionStatus @map("status")
  quantity        Int               @map("jumlah")
  transactionDate DateTime          @map("tanggal_transaksi")
  paymentMethod   PaymentMethod     @map("metode_pembayaran")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier  Supplier? @relation(fields: [supplierId], references: [id])
  handledBy User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId, transactionDate])
  @@map("transaksi_masuk")
}

model StockOutTransaction {
  id              String   @id @default(uuid()) @map("id_transaksi_keluar")
  userId          String   @map("id_user")
  productId       String   @map("id_stok") // bahan yang berkurang
  menuId          String?  @map("id_menu") // OPSIONAL: kalau keluar karena menu tertentu
  transactionName String   @map("nama_transaksi") // misal: "PENJUALAN_UPLOAD_2025-11-20"
  quantity        Int      @map("jumlah") // stok yang keluar (gram/ml/pcs)
  transactionDate DateTime @map("tanggal_transaksi")
  note            String?  @map("catatan") // keterangan tambahan (opsional)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  menu      Menu?   @relation(fields: [menuId], references: [id])
  handledBy User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([menuId])
  @@index([userId, transactionDate])
  @@map("transaksi_keluar")
}

model Notification {
  id           String               @id @default(uuid()) @map("id_notifikasi")
  userId       String               @map("id_user")
  productId    String?              @map("id_stok")
  targetRoleId String?              @map("id_role_tujuan")
  type         NotificationType     @default(LOW_STOCK) @map("tipe")
  severity     NotificationSeverity @default(INFO) @map("tingkat")
  message      String               @map("pesan")
  isRead       Boolean              @default(false) @map("sudah_dibaca")
  readAt       DateTime?            @map("dibaca_pada")
  notifiedAt   DateTime             @default(now()) @map("tanggal")
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      Product?             @relation(fields: [productId], references: [id])
  targetRole   Role?                @relation(fields: [targetRoleId], references: [id])

  @@index([userId, notifiedAt])
  @@index([targetRoleId, isRead])
  @@map("notifikasi")
}

model Menu {
  id        String   @id @default(uuid()) @map("id_menu")
  code      String   @unique @map("kode_menu")
  name      String   @map("nama_menu")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  recipes              Recipe[]
  stockOutTransactions StockOutTransaction[]

  deletedAt DateTime? @map("deleted_at")

  @@map("menu")
}

model Recipe {
  id            String   @id @default(uuid()) @map("id_resep")
  menuId        String   @map("id_menu")
  productId     String   @map("id_stok")
  qtyPerPortion Decimal  @map("qty_per_porsi")
  unit          String?  @map("satuan")
  createdAt     DateTime @default(now()) @map("created_at")

  menu    Menu    @relation(fields: [menuId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([menuId, productId], map: "unique_menu_stok")
  @@map("resep")
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CASH
  TRANSFER
  OTHER
}

enum MeasurementUnit {
  GRAM
  KG
  ML
  PCS
}

enum NotificationType {
  LOW_STOCK
  STOCK_OUT
  SYSTEM
}

enum NotificationSeverity {
  INFO
  WARNING
  CRITICAL
}
